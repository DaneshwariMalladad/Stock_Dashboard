<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stock Broker Dashboard</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Chart.js Data Labels Plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    body { background-color: #121212; color: #ffffff; }
    .card { background-color: #1e1e1e; border: 1px solid #333; }
    .btn-primary { background-color: #28a745; border-color: #28a745; }
    .btn-primary:hover { background-color: #218838; }
    .trend-up { color: #28a745; }
    .trend-down { color: #dc3545; }
    .chart-container { position: relative; height: 150px; width: 100%; }
    .dark-mode-toggle { position: absolute; top: 10px; right: 10px; }
  </style>
</head>
<body>
  <div class="container mt-5">
    <!-- Dark Mode Toggle -->
    <button id="darkModeToggle" class="btn btn-secondary dark-mode-toggle"><i class="fas fa-moon"></i> Dark Mode</button>

    <div id="login" class="text-center">
      <div class="card p-4 mx-auto" style="max-width: 400px;">
        <h2><i class="fas fa-user"></i> Login</h2>
        <input type="email" id="email" class="form-control mb-3" placeholder="Enter your email" required>
        <button id="loginBtn" class="btn btn-primary w-100"><i class="fas fa-sign-in-alt"></i> Login</button>
      </div>
    </div>

    <div id="dashboard" class="d-none">
      <h2 class="text-center mb-4"><i class="fas fa-chart-line"></i> Welcome, <span id="userEmail"></span></h2>
      
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="card p-3">
            <h5><i class="fas fa-plus-circle"></i> Subscribe to Stocks</h5>
            <select id="stockSelect" class="form-select mb-3">
              <option value="">Select a stock</option>
            </select>
            <button id="subscribeBtn" class="btn btn-primary"><i class="fas fa-plus"></i> Subscribe</button>
          </div>
        </div>
      </div>

      <h3><i class="fas fa-list"></i> Your Subscribed Stocks</h3>
      <div id="subscriptions" class="row"></div>
    </div>
  </div>

  <!-- Toast Notifications -->
  <div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="toast" class="toast" role="alert">
      <div class="toast-body" id="toastMessage"></div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const socket = io();
    let userEmail = '';
    let charts = {}; // Store chart instances

    // Dark Mode Toggle
    document.getElementById('darkModeToggle').addEventListener('click', () => {
      document.body.classList.toggle('bg-light');
      document.body.classList.toggle('text-dark');
      document.querySelectorAll('.card').forEach(card => card.classList.toggle('bg-white'));
    });

    // Login
    document.getElementById('loginBtn').addEventListener('click', () => {
      userEmail = document.getElementById('email').value;
      if (userEmail) {
        document.getElementById('loginBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
        socket.emit('login', userEmail);
      }
    });

    socket.on('loginSuccess', (data) => {
      document.getElementById('login').classList.add('d-none');
      document.getElementById('dashboard').classList.remove('d-none');
      document.getElementById('userEmail').textContent = userEmail;
      document.getElementById('loginBtn').innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';

      // Populate stock select
      const select = document.getElementById('stockSelect');
      data.supportedStocks.forEach(stock => {
        const option = document.createElement('option');
        option.value = stock;
        option.textContent = stock;
        select.appendChild(option);
      });

      showToast('Logged in successfully!', 'success');
    });

    // Subscribe
    document.getElementById('subscribeBtn').addEventListener('click', () => {
      const ticker = document.getElementById('stockSelect').value;
      if (ticker) {
        document.getElementById('subscribeBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Subscribing...';
        socket.emit('subscribe', ticker);
      }
    });

    socket.on('subscribed', (ticker) => {
      document.getElementById('subscribeBtn').innerHTML = '<i class="fas fa-plus"></i> Subscribe';
      showToast(`Subscribed to ${ticker}!`, 'success');
    });

    // Price updates
    socket.on('priceUpdate', (data) => {
      const { prices, histories } = data;
      Object.keys(prices).forEach(ticker => {
        let stockDiv = document.getElementById(`stock-${ticker}`);
        if (!stockDiv) {
          const subs = document.getElementById('subscriptions');
          stockDiv = document.createElement('div');
          stockDiv.className = 'col-md-4 mb-3';
          stockDiv.id = `stock-${ticker}`;
          stockDiv.innerHTML = `
  <div class="card p-3">
    <h5 style="color:#ffffff;">
      <i class="fas fa-chart-line text-success"></i> ${ticker}
    </h5>

    <p style="color:#cccccc;">
      Price:
      <span class="price fw-bold" id="price-${ticker}" style="color:#00ffcc;">
        $${prices[ticker]}
      </span>
      <span id="trend-${ticker}"></span>
    </p>

    <div class="chart-container">
      <canvas id="chart-${ticker}"></canvas>
    </div>
  </div>
`;

          subs.appendChild(stockDiv);
          createChart(ticker, histories[ticker]);
        } else {
          const priceEl = document.getElementById(`price-${ticker}`);
          const oldPrice = parseFloat(priceEl.textContent);
          const newPrice = parseFloat(prices[ticker]);
          priceEl.textContent = prices[ticker];

          // Update trend
          const trendEl = document.getElementById(`trend-${ticker}`);
          if (newPrice > oldPrice) {
            trendEl.innerHTML = '<i class="fas fa-arrow-up trend-up"></i>';
          } else if (newPrice < oldPrice) {
            trendEl.innerHTML = '<i class="fas fa-arrow-down trend-down"></i>';
          }

          // Update chart
          updateChart(ticker, histories[ticker]);
        }
      });
    });

    function createChart(ticker, history) {
      const ctx = document.getElementById(`chart-${ticker}`).getContext('2d');
      charts[ticker] = new Chart(ctx, {
        type: 'line',
        data: {
          labels: history.map((_, i) => `Update ${i + 1}`),
          datasets: [{
            label: 'Price',
            data: history,
            borderColor: '#28a745',
            backgroundColor: 'rgba(40, 167, 69, 0.1)',
            fill: true,
            pointRadius: 4,
            pointHoverRadius: 6,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: {
                color: '#ffffff' // White text for legend visibility
              }
            },
            datalabels: {
              color: '#28a745',
              font: { size: 12, weight: 'bold' },
              formatter: (value) => `$${value.toFixed(2)}`,
              anchor: 'end',
              align: 'top',
              offset: 5,
            },
            tooltip: {
              callbacks: {
                label: (context) => `Price: $${context.parsed.y.toFixed(2)}`,
              },
            },
          },
          scales: {
            y: { 
              beginAtZero: false,
              ticks: { color: '#ffffff' } // White y-axis labels
            },
            x: { 
              display: false // Hide x-axis for cleaner look
            },
          },
        },
        plugins: [ChartDataLabels], // Enable data labels plugin
      });
    }

    function updateChart(ticker, history) {
      if (charts[ticker]) {
        charts[ticker].data.datasets[0].data = history;
        charts[ticker].update();
      }
    }

    function showToast(message, type) {
      const toastEl = document.getElementById('toast');
      document.getElementById('toastMessage').textContent = message;
      toastEl.classList.add(`text-bg-${type}`);
      const toast = new bootstrap.Toast(toastEl);
      toast.show();
    }
  </script>
</body>
</html>